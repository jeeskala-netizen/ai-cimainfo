<!DOCTYPE html>
<html lang="{{ lang }}" dir="{{ t['dir'] }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t['app_title'] }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div class="nav-wrapper">
        <div class="logo">{{ t['app_title'] }}</div>
        <ul class="nav-menu">
            <li onclick="showPage('chat_home')" class="active"><i class="fa-solid fa-comments"></i> {{ t['menu'][0] }}</li>
            <li onclick="showPage('browse_movies'); loadContent('movie', 'm-res')"><i class="fa-solid fa-film"></i> {{ t['menu'][1] }}</li>
            <li onclick="showPage('browse_tv'); loadContent('tv', 't-res')"><i class="fa-solid fa-tv"></i> {{ t['menu'][2] }}</li>
            <li onclick="showPage('visual_detective')"><i class="fa-solid fa-camera"></i> {{ t['menu'][3] }}</li>
            <li onclick="showPage('dna_analysis')"><i class="fa-solid fa-fingerprint"></i> {{ t['menu'][4] }}</li>
            <li onclick="showPage('matchmaker')"><i class="fa-solid fa-people-arrows"></i> {{ t['menu'][5] }}</li>
            <li onclick="showPage('library')"><i class="fa-solid fa-heart"></i> {{ t['menu'][6] }}</li>
        </ul>
        <div class="lang-switch">
            <a href="/change_lang/ar">AR</a> | <a href="/change_lang/en">EN</a> | <a href="/change_lang/de">DE</a>
        </div>
    </div>

    <div class="main-container">
        
        <div id="chat_home" class="page-section active-section">
            
            <div class="controls-wrapper">
                <span style="color:#aaa; font-size:0.9rem;"><i class="fa-solid fa-masks-theater"></i></span>
                
                <div class="custom-dropdown" id="persona-dropdown">
                    <div class="dropdown-selected" onclick="toggleDropdown()">
                        <span id="selected-text">{{ t['personas'][0] }}</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div class="dropdown-options">
                        {% for i in range(4) %}
                            <div class="option-item" onclick="selectPersona({{ i }}, '{{ t['personas'][i] }}')">
                                {{ t['personas'][i] }}
                            </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" id="persona-value" value="0">
                </div>

                <div style="width:1px; height:20px; background:rgba(255,255,255,0.2);"></div>

                <button class="refresh-btn" onclick="resetChat()" title="{{ t['new_chat'] }}">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
            </div>

            <div id="chatbox" class="chat-box">
                <div class="message bot-msg">
                    <div class="avatar">ü§ñ</div>
                    <div class="bubble" id="welcome-bubble">{{ t['welcome_msgs'][0] }}</div>
                </div>
            </div>

            <div class="input-area">
                <input type="text" id="user-input" placeholder="{{ t['input_placeholder'] }}">
                <button class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="browse_movies" class="page-section">
            <div class="section-header"><h1>{{ t['browse_movies'] }}</h1></div>
            <div class="glass-container" style="flex-direction: row; align-items: center;">
                <input type="text" id="m-search" placeholder="{{ t['search_placeholder'] }}">
                <button class="send-btn" onclick="search('m-search', 'movie', 'm-res')">üîç</button>
            </div>
            <div id="m-res" class="universal-grid"></div>
        </div>

        <div id="browse_tv" class="page-section">
            <div class="section-header"><h1>{{ t['browse_tv'] }}</h1></div>
            <div class="glass-container" style="flex-direction: row; align-items: center;">
                <input type="text" id="t-search" placeholder="{{ t['search_placeholder'] }}">
                <button class="send-btn" onclick="search('t-search', 'tv', 't-res')">üîç</button>
            </div>
            <div id="t-res" class="universal-grid"></div>
        </div>

        <div id="visual_detective" class="page-section">
            <div class="section-header">
                <h1>{{ t['header_visual'] }}</h1>
                <p>{{ t['visual_desc'] }}</p>
            </div>
            <div class="glass-container" style="text-align: center;">
                <input type="file" id="img-up" style="display:none" accept="image/*" onchange="previewImage()">
                <div class="file-upload-wrapper" onclick="document.getElementById('img-up').click()">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size: 3rem; color: #6a11cb;"></i>
                    <p>{{ t['upload_text'] }}</p>
                </div>
                <img id="img-preview" style="max-width: 100%; margin-top: 20px; border-radius: 15px; display: none;">
                <br>
                <button id="analyze-btn" class="btn-glow" style="display:none;" onclick="analyzeImage()">{{ t['analyze_btn'] }}</button>
            </div>
            <div id="v-res" class="chat-box"></div>
        </div>

        <div id="dna_analysis" class="page-section">
            <div class="section-header">
                <h1>{{ t['header_dna'] }}</h1>
                <p>{{ t['descs'][1] }}</p>
            </div>
            <div class="glass-container">
                <input type="text" id="d1" placeholder="{{ t['dna_inputs'][0] }}">
                <input type="text" id="d2" placeholder="{{ t['dna_inputs'][1] }}">
                <input type="text" id="d3" placeholder="{{ t['dna_inputs'][2] }}">
                <button class="btn-glow" onclick="analyzeDNA()">{{ t['dna_btn'] }}</button>
            </div>
            <div id="d-res" class="chat-box" style="margin-top:20px;"></div>
        </div>

        <div id="matchmaker" class="page-section">
            <div class="section-header">
                <h1>{{ t['header_match'] }}</h1>
                <p>{{ t['match_desc'] }}</p>
            </div>
            <div class="glass-container">
                <div style="display:flex; gap:10px; width:100%;">
                    <input type="text" id="u1" placeholder="{{ t['match_inputs'][0] }}">
                    <input type="text" id="u2" placeholder="{{ t['match_inputs'][1] }}">
                </div>
                <button class="btn-glow" onclick="findMatch()">{{ t['match_btn'] }}</button>
            </div>
            <div id="ma-res" class="chat-box" style="margin-top:20px;"></div>
        </div>

        <div id="library" class="page-section">
            <div class="section-header"><h1>{{ t['header_fav'] }}</h1></div>
            <div class="glass-container" style="text-align:center;">
                <p>üöß (ŸÇÿ±Ÿäÿ®ÿßŸã)</p>
            </div>
        </div>

    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('modal').style.display='none'">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        const t_welcome = {{ t['welcome_msgs'] | tojson }};
        const t_personas = {{ t['personas'] | tojson }};

        // 1. ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ© ÿßŸÑÿ™ŸÅÿßÿπŸÑŸäÿ©
        function toggleDropdown() {
            document.getElementById("persona-dropdown").classList.toggle("active");
        }

        function selectPersona(index, name) {
            document.getElementById("selected-text").innerText = name;
            document.getElementById("persona-value").value = index;
            document.getElementById("persona-dropdown").classList.remove("active");
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿ±ÿ≠Ÿäÿ® ŸÅŸàÿ±ÿßŸã
            const bubble = document.getElementById('welcome-bubble');
            bubble.innerText = t_welcome[index];
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ ÿßŸÑÿ®ÿ≥Ÿäÿ∑
            bubble.style.animation = 'none';
            bubble.offsetHeight; /* trigger reflow */
            bubble.style.animation = 'fadeIn 0.5s';
        }

        // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-selected') && !event.target.matches('.dropdown-selected *')) {
                const d = document.getElementById("persona-dropdown");
                if (d.classList.contains('active')) d.classList.remove('active');
            }
        }

        // 2. ÿßŸÑÿ™ŸÜŸÇŸÑ
        function showPage(id) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active-section'));
            document.getElementById(id).classList.add('active-section');
            document.querySelectorAll('.nav-menu li').forEach(li => li.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // 3. ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
        async function loadContent(type, outputId) {
            const div = document.getElementById(outputId);
            if(div.innerHTML.trim() !== "") return;
            div.innerHTML = '<div style="text-align:center; padding:20px;">Loading...</div>';
            const fd = new FormData(); fd.append('type', type);
            try {
                const res = await fetch('/browse_content', {method:'POST', body:fd});
                const data = await res.json();
                renderGrid(data.movies, div);
            } catch(e) { div.innerHTML = '<p style="text-align:center;">Error.</p>'; }
        }

        function renderGrid(movies, container) {
            container.innerHTML = '';
            if(movies.length === 0) { container.innerHTML = '<p style="text-align:center">No results.</p>'; return; }
            
            let html = `<div class="universal-grid">`;
            movies.forEach(m => {
                const mStr = JSON.stringify(m).replace(/"/g, "&quot;");
                html += `
                <div class="modern-card" onclick="openModal(${mStr})">
                    <img src="${m.poster}">
                    <div class="overlay"><h4>${m.title}</h4></div>
                </div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        // 4. ÿßŸÑÿ¥ÿßÿ™
        function resetChat() {
            const idx = document.getElementById("persona-value").value;
            document.getElementById('chatbox').innerHTML = `
                <div class="message bot-msg"><div class="avatar">ü§ñ</div><div class="bubble">${t_welcome[idx]}</div></div>`;
        }

        async function sendMessage() {
            const msg = document.getElementById('user-input').value;
            if(!msg) return;
            const box = document.getElementById('chatbox');
            box.innerHTML += `<div class="message user-msg"><div class="bubble">${msg}</div></div>`;
            document.getElementById('user-input').value = '';
            
            const lid = 'l-'+Date.now();
            box.innerHTML += `<div id="${lid}" class="message bot-msg"><div class="avatar">ü§ñ</div><div class="bubble">...</div></div>`;
            box.scrollTop = box.scrollHeight;

            const fd = new FormData();
            fd.append('msg', msg);
            fd.append('persona', t_personas[document.getElementById('persona-value').value]); // ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÜÿµŸä ŸÑŸÑÿ¥ÿÆÿµŸäÿ©

            const res = await fetch('/chat', {method:'POST', body:fd});
            const data = await res.json();
            document.getElementById(lid).remove();
            
            let html = `<div class="message bot-msg"><div class="avatar">ü§ñ</div><div class="bubble">${data.response.replace(/\n/g, '<br>')}</div></div>`;
            if(data.movies && data.movies.length>0) {
                html += `<div style="display:flex; gap:10px; overflow-x:auto; padding:10px 0 10px 50px;">`;
                data.movies.forEach(m => {
                    const mStr = JSON.stringify(m).replace(/"/g, "&quot;");
                    html += `<div class="modern-card" style="min-width:120px; aspect-ratio:2/3;" onclick="openModal(${mStr})"><img src="${m.poster}"></div>`;
                });
                html += `</div>`;
            }
            box.innerHTML += html;
            box.scrollTop = box.scrollHeight;
        }

        // 5. ÿßŸÑŸÖŸäÿ≤ÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâ
        async function search(inId, type, outId) {
            const q = document.getElementById(inId).value;
            const fd = new FormData(); fd.append('query', q); fd.append('type', type);
            const res = await fetch('/search', {method:'POST', body:fd});
            const data = await res.json();
            renderGrid(data.movies, document.getElementById(outId));
        }

        // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑŸÖŸàÿ≠ÿØ
        function renderAnalysisResult(data, containerId) {
            const div = document.getElementById(containerId);
            let html = `<div class="glass-container" style="border-left:4px solid #6a11cb; text-align:right;">
                <p>${data.response.replace(/\n/g, '<br>')}</p>
            </div>`;
            renderGrid(data.movies, div); // Ÿäÿ∂ŸäŸÅ ÿßŸÑÿ¥ÿ®ŸÉÿ© ÿ®ÿπÿØ ÿßŸÑŸÜÿµ
            div.innerHTML = html + div.innerHTML;
        }

        async function analyzeImage() {
            const fd = new FormData(); fd.append('image', document.getElementById('img-up').files[0]);
            const res = await fetch('/analyze_image', {method:'POST', body:fd});
            renderAnalysisResult(await res.json(), 'v-res');
        }
        
        async function analyzeDNA() {
            const fd = new FormData();
            fd.append('m1', document.getElementById('d1').value);
            fd.append('m2', document.getElementById('d2').value);
            fd.append('m3', document.getElementById('d3').value);
            const res = await fetch('/analyze_dna', {method:'POST', body:fd});
            renderAnalysisResult(await res.json(), 'd-res');
        }

        async function findMatch() {
            const fd = new FormData();
            fd.append('u1', document.getElementById('u1').value);
            fd.append('u2', document.getElementById('u2').value);
            const res = await fetch('/matchmaker', {method:'POST', body:fd});
            renderAnalysisResult(await res.json(), 'ma-res');
        }

        function previewImage() {
            const file = document.getElementById('img-up').files[0];
            if(file) {
                document.getElementById('img-preview').src = URL.createObjectURL(file);
                document.getElementById('img-preview').style.display = 'block';
                document.getElementById('analyze-btn').style.display = 'inline-block';
            }
        }

        // 6. Modal
        async function openModal(movie) {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            modal.style.display = "flex";
            
            body.innerHTML = `
                <div style="height:350px; background:url('${movie.poster}') center/cover; position:relative;">
                    <div style="position:absolute; bottom:0; width:100%; background:linear-gradient(to top, #161625, transparent); padding:30px;">
                        <h1 style="margin:0; text-shadow:0 0 10px black;">${movie.title}</h1>
                    </div>
                </div>
                <div style="padding:30px;">
                    <p style="line-height:1.8; font-size:1.1rem;">${movie.overview}</p>
                    <div id="provs" style="margin-top:20px;">Wait...</div>
                </div>`;
            
            const fd = new FormData(); fd.append('id', movie.id); fd.append('type', movie.type);
            const res = await fetch('/get_details', {method:'POST', body:fd});
            const data = await res.json();
            
            let pHTML = `<div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">`;
            if(data.providers.length > 0) data.providers.forEach(p => pHTML += `<img src="${p.logo}" width="50" style="border-radius:10px;" title="${p.name}">`);
            else pHTML += `<span style="color:#888">Not available digitally</span>`;
            
            if(data.trailer) pHTML += `<a href="https://www.youtube.com/watch?v=${data.trailer}" target="_blank" class="btn-glow" style="text-decoration:none; padding:10px 20px; margin-right:auto; width:auto;">‚ñ∂ Trailer</a>`;
            pHTML += `</div>`;
            document.getElementById('provs').innerHTML = pHTML;
        }

        document.getElementById("user-input").addEventListener("keypress", function(e){if(e.key==="Enter") sendMessage();});
    </script>
</body>
</html>