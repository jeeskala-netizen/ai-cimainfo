<!DOCTYPE html>
<html lang="{{ lang }}" dir="{{ t['dir'] }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t['app_title'] }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div class="nav-wrapper">
        <div class="logo">{{ t['app_title'] }}</div>
        <ul class="nav-menu">
            <li onclick="showPage('chat_home')" class="active"><i class="fa-solid fa-comments"></i> {{ t['menu'][0] }}</li>
            <li onclick="showPage('browse_movies'); loadContent('movie', 'm-res')"><i class="fa-solid fa-film"></i> {{ t['menu'][1] }}</li>
            <li onclick="showPage('browse_tv'); loadContent('tv', 't-res')"><i class="fa-solid fa-tv"></i> {{ t['menu'][2] }}</li>
            <li onclick="showPage('visual_detective')"><i class="fa-solid fa-camera"></i> {{ t['menu'][3] }}</li>
            <li onclick="showPage('dna_analysis')"><i class="fa-solid fa-fingerprint"></i> {{ t['menu'][4] }}</li>
            <li onclick="showPage('matchmaker')"><i class="fa-solid fa-people-arrows"></i> {{ t['menu'][5] }}</li>
            <li onclick="showPage('library')"><i class="fa-solid fa-heart"></i> {{ t['menu'][6] }}</li>
        </ul>
        <div class="lang-switch">
            <a href="/change_lang/ar">AR</a> | <a href="/change_lang/en">EN</a>
        </div>
    </div>

    <div class="main-container">
        
        <div id="chat_home" class="page-section active-section">
            <div class="chat-home-layout">
                <div class="controls-wrapper">
                    <span style="color:#aaa;"><i class="fa-solid fa-masks-theater"></i></span>
                    <div class="custom-dropdown" id="persona-dropdown">
                        <div class="dropdown-selected" onclick="toggleDropdown()">
                            <span id="selected-text">{{ t['personas'][0] }}</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                        <div class="dropdown-options">
                            {% for i in range(4) %}
                                <div class="option-item" onclick="selectPersona({{ i }}, '{{ t['personas'][i] }}')">
                                    {{ t['personas'][i] }}
                                </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" id="persona-value" value="0">
                    </div>
                    <button class="refresh-btn" onclick="resetChat()"><i class="fa-solid fa-rotate-right"></i></button>
                </div>

                <div id="chatbox" class="chat-box">
                    <div class="message bot-msg">
                        <div class="avatar">ü§ñ</div>
                        <div class="bubble" id="welcome-bubble">{{ t['welcome_msgs'][0] }}</div>
                    </div>
                </div>

                <div class="input-area">
                    <input type="text" id="user-input" placeholder="{{ t['input_placeholder'] }}">
                    <button class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="browse_movies" class="page-section">
            <div class="section-header"><h1>{{ t['browse_movies'] }}</h1></div>
            <div class="glass-container" style="flex-direction: row; padding: 10px;">
                <input type="text" id="m-search" placeholder="{{ t['search_placeholder'] }}" style="background:transparent; border:none;">
                <button class="send-btn" onclick="search('m-search', 'movie', 'm-res')" style="width:40px; height:40px;">üîç</button>
            </div>
            <div id="m-res" class="grid-container" style="margin-top:20px;"></div>
        </div>

        <div id="browse_tv" class="page-section">
            <div class="section-header"><h1>{{ t['browse_tv'] }}</h1></div>
            <div class="glass-container" style="flex-direction: row; padding: 10px;">
                <input type="text" id="t-search" placeholder="{{ t['search_placeholder'] }}" style="background:transparent; border:none;">
                <button class="send-btn" onclick="search('t-search', 'tv', 't-res')" style="width:40px; height:40px;">üîç</button>
            </div>
            <div id="t-res" class="grid-container" style="margin-top:20px;"></div>
        </div>

        <div id="visual_detective" class="page-section">
            <div class="section-header">
                <h1>{{ t['headers'][0] }}</h1>
                <p>{{ t['descs'][0] }}</p>
            </div>
            <div class="glass-container" style="text-align: center;">
                <input type="file" id="img-up" hidden onchange="previewImage()">
                <div onclick="document.getElementById('img-up').click()" style="cursor:pointer; border:2px dashed #6a11cb; padding:30px; border-radius:15px;">
                    <i class="fa-solid fa-cloud-upload-alt" style="font-size:3rem; color:#6a11cb;"></i>
                    <p>{{ t['upload_text'] }}</p>
                </div>
                <img id="img-preview" style="max-width:100%; margin-top:15px; border-radius:10px; display:none;">
                <button id="analyze-btn" class="btn-glow" style="display:none; margin-top:15px;" onclick="analyzeImage()">{{ t['analyze_btn'] }}</button>
            </div>
            <div id="v-res" class="chat-box" style="margin-top:20px;"></div>
        </div>

        <div id="dna_analysis" class="page-section">
            <div class="section-header">
                <h1>{{ t['headers'][1] }}</h1>
                <p>{{ t['descs'][1] }}</p>
            </div>
            <div class="glass-container">
                <input type="text" id="d1" placeholder="{{ t['dna_inputs'][0] }}" style="width:100%; padding:10px; border-radius:8px; border:none; background:rgba(255,255,255,0.1); color:white;">
                <input type="text" id="d2" placeholder="{{ t['dna_inputs'][1] }}" style="width:100%; padding:10px; border-radius:8px; border:none; background:rgba(255,255,255,0.1); color:white;">
                <input type="text" id="d3" placeholder="{{ t['dna_inputs'][2] }}" style="width:100%; padding:10px; border-radius:8px; border:none; background:rgba(255,255,255,0.1); color:white;">
                <button class="btn-glow" onclick="analyzeDNA()">{{ t['dna_btn'] }}</button>
            </div>
            <div id="d-res" class="chat-box" style="margin-top:20px;"></div>
        </div>

        <div id="matchmaker" class="page-section">
            <div class="section-header">
                <h1>{{ t['headers'][2] }}</h1>
                <p>{{ t['descs'][2] }}</p>
            </div>
            <div class="glass-container">
                <div style="display:flex; gap:10px; width:100%;">
                    <input type="text" id="u1" placeholder="{{ t['match_inputs'][0] }}" style="width:100%; padding:10px; border-radius:8px; border:none; background:rgba(255,255,255,0.1); color:white;">
                    <input type="text" id="u2" placeholder="{{ t['match_inputs'][1] }}" style="width:100%; padding:10px; border-radius:8px; border:none; background:rgba(255,255,255,0.1); color:white;">
                </div>
                <button class="btn-glow" onclick="findMatch()">{{ t['match_btn'] }}</button>
            </div>
            <div id="ma-res" class="chat-box" style="margin-top:20px;"></div>
        </div>

        <div id="library" class="page-section">
            <div class="section-header"><h1>{{ t['headers'][4] }}</h1></div>
            <div class="glass-container" style="text-align:center;">
                <p>üöß (ŸÇÿ±Ÿäÿ®ÿßŸã)</p>
            </div>
        </div>

    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('modal').style.display='none'">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        const t_welcome = {{ t['welcome_msgs'] | tojson }};
        const t_personas = {{ t['personas'] | tojson }};

        function showPage(id) {
            // ÿ•ÿÆŸÅÿßÿ° ŸÉŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active-section'));
            // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ŸÅŸÇÿ∑
            document.getElementById(id).classList.add('active-section');
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
            document.querySelectorAll('.nav-menu li').forEach(li => li.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function toggleDropdown() { document.getElementById("persona-dropdown").classList.toggle("active"); }
        
        function selectPersona(index, name) {
            document.getElementById("selected-text").innerText = name;
            document.getElementById("persona-value").value = index;
            document.getElementById("persona-dropdown").classList.remove("active");
            document.getElementById('welcome-bubble').innerText = t_welcome[index];
        }

        window.onclick = function(e) {
            if (!e.target.matches('.dropdown-selected') && !e.target.matches('.dropdown-selected *')) {
                document.getElementById("persona-dropdown").classList.remove('active');
            }
        }

        function resetChat() {
            const idx = document.getElementById("persona-value").value;
            document.getElementById('chatbox').innerHTML = `
                <div class="message bot-msg"><div class="avatar">ü§ñ</div><div class="bubble">${t_welcome[idx]}</div></div>`;
        }

        async function loadContent(type, outputId) {
            const div = document.getElementById(outputId);
            if(div.innerHTML.trim() !== "") return;
            div.innerHTML = '<div style="text-align:center; color:#ccc;">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>';
            try {
                const fd = new FormData(); fd.append('type', type);
                const res = await fetch('/browse_content', {method:'POST', body:fd});
                const data = await res.json();
                renderGrid(data.movies, div);
            } catch(e) { div.innerHTML = 'Error'; }
        }

        function renderGrid(movies, container) {
            container.innerHTML = '';
            let html = `<div class="grid-container">`;
            movies.forEach(m => {
                const mStr = JSON.stringify(m).replace(/"/g, "&quot;");
                html += `<div class="movie-card" onclick="openModal(${mStr})"><img src="${m.poster}"><h4>${m.title}</h4></div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        // ... (ÿ®ÿßŸÇŸä ÿßŸÑÿØŸàÿßŸÑ: sendMessage, search, analyzeImage, analyzeDNA, findMatch, openModal - ÿßŸÜÿ≥ÿÆŸáÿß ŸÖŸÜ ÿßŸÑÿ±ÿØ ÿßŸÑÿ≥ÿßÿ®ŸÇÿå ŸáŸä ÿ™ÿπŸÖŸÑ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠) ...
        // ŸÑŸÑÿ•Ÿäÿ¨ÿßÿ≤ÿå ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÜÿ≥ÿÆ ÿØÿßŸÑÿ© openModal Ÿà sendMessage ŸÉŸÖÿß ŸÉÿßŸÜÿ™.
        
        async function sendMessage() {
            const msg = document.getElementById('user-input').value;
            if(!msg) return;
            const box = document.getElementById('chatbox');
            box.innerHTML += `<div class="message user-msg"><div class="bubble">${msg}</div></div>`;
            document.getElementById('user-input').value = '';
            
            const lid = 'l-'+Date.now();
            box.innerHTML += `<div id="${lid}" class="message bot-msg"><div class="avatar">ü§ñ</div><div class="bubble">...</div></div>`;
            box.scrollTop = box.scrollHeight;

            const fd = new FormData();
            fd.append('msg', msg);
            fd.append('persona', t_personas[document.getElementById('persona-value').value]);

            const res = await fetch('/chat', {method:'POST', body:fd});
            const data = await res.json();
            document.getElementById(lid).remove();
            
            let html = `<div class="message bot-msg"><div class="avatar">ü§ñ</div><div class="bubble">${data.response.replace(/\n/g, '<br>')}</div></div>`;
            if(data.movies && data.movies.length>0) {
                html += `<div style="display:flex; gap:10px; overflow-x:auto; padding:10px 0 10px 50px;">`;
                data.movies.forEach(m => {
                    const mStr = JSON.stringify(m).replace(/"/g, "&quot;");
                    html += `<div class="movie-card" style="min-width:120px; aspect-ratio:2/3;" onclick="openModal(${mStr})"><img src="${m.poster}"></div>`;
                });
                html += `</div>`;
            }
            box.innerHTML += html;
            box.scrollTop = box.scrollHeight;
        }

        async function search(inId, type, outId) {
            const q = document.getElementById(inId).value;
            const fd = new FormData(); fd.append('query', q); fd.append('type', type);
            const res = await fetch('/search', {method:'POST', body:fd});
            const data = await res.json();
            renderGrid(data.movies, document.getElementById(outId));
        }

        function renderResults(data, containerId) {
            const div = document.getElementById(containerId);
            let html = `<div class="glass-container" style="text-align:right;"><p>${data.response.replace(/\n/g, '<br>')}</p></div>`;
            renderGrid(data.movies, div);
            div.innerHTML = html + div.innerHTML;
        }

        async function analyzeImage() {
            const fd = new FormData(); fd.append('image', document.getElementById('img-up').files[0]);
            const res = await fetch('/analyze_image', {method:'POST', body:fd});
            renderResults(await res.json(), 'v-res');
        }
        async function analyzeDNA() {
            const fd = new FormData();
            fd.append('m1', document.getElementById('d1').value);
            fd.append('m2', document.getElementById('d2').value);
            fd.append('m3', document.getElementById('d3').value);
            const res = await fetch('/analyze_dna', {method:'POST', body:fd});
            renderResults(await res.json(), 'd-res');
        }
        async function findMatch() {
            const fd = new FormData();
            fd.append('u1', document.getElementById('u1').value);
            fd.append('u2', document.getElementById('u2').value);
            const res = await fetch('/matchmaker', {method:'POST', body:fd});
            renderResults(await res.json(), 'ma-res');
        }
        
        function previewImage() {
            const file = document.getElementById('img-up').files[0];
            if(file) {
                document.getElementById('img-preview').src = URL.createObjectURL(file);
                document.getElementById('img-preview').style.display = 'block';
                document.getElementById('analyze-btn').style.display = 'inline-block';
            }
        }

        async function openModal(movie) {
            const modal = document.getElementById('modal');
            modal.style.display = "flex";
            const body = document.getElementById('modal-body');
            body.innerHTML = `
                <div style="height:300px; background:url('${movie.poster}') center/cover; position:relative;">
                    <div style="position:absolute; bottom:0; background:linear-gradient(to top, #1a1a2e, transparent); width:100%; padding:20px; box-sizing:border-box;">
                        <h1 style="margin:0; text-shadow:0 0 10px black">${movie.title}</h1>
                    </div>
                </div>
                <div style="padding:20px;">
                    <p style="line-height:1.6">${movie.overview}</p>
                    <div id="provs" style="margin-top:20px">Loading...</div>
                </div>`;
            const fd = new FormData(); fd.append('id', movie.id); fd.append('type', movie.type);
            const res = await fetch('/get_details', {method:'POST', body:fd});
            const data = await res.json();
            let pHTML = `<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">`;
            if(data.providers.length > 0) data.providers.forEach(p => pHTML += `<img src="${p.logo}" width="45" style="border-radius:10px;">`);
            else pHTML += `<span style="color:#777">Not on streaming.</span>`;
            if(data.trailer) pHTML += `<a href="https://youtube.com/watch?v=${data.trailer}" target="_blank" class="btn-glow" style="margin-right:auto; width:auto; padding:8px 20px; text-decoration:none;">üé• Trailer</a>`;
            pHTML += `</div>`;
            document.getElementById('provs').innerHTML = pHTML;
        }

        document.getElementById("user-input").addEventListener("keypress", function(e){ if(e.key==="Enter") sendMessage(); });
    </script>
</body>
</html>
