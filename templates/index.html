<!DOCTYPE html>
<html lang="{{ lang }}" dir="{{ t['dir'] }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ t['app_title'] }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div class="nav-wrapper">
        <div class="logo">{{ t['app_title'] }}</div>
        
        <div class="hamburger" onclick="toggleMenu()">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </div>

        <ul class="nav-menu" id="navMenu">
            <div style="width:100%; text-align:left; padding:10px; display:none;" class="mobile-close" onclick="toggleMenu()">
                <i class="fa-solid fa-xmark" style="font-size:1.5rem; color:white;"></i>
            </div>
            
            <li onclick="showPage('chat_home')" class="active"><i class="fa-solid fa-comments"></i> {{ t['menu'][0] }}</li>
            <li onclick="showPage('browse_movies'); loadContent('movie', 'm-res')"><i class="fa-solid fa-film"></i> {{ t['menu'][1] }}</li>
            <li onclick="showPage('browse_tv'); loadContent('tv', 't-res')"><i class="fa-solid fa-tv"></i> {{ t['menu'][2] }}</li>
            <li onclick="showPage('visual_detective')"><i class="fa-solid fa-camera"></i> {{ t['menu'][3] }}</li>
            <li onclick="showPage('dna_analysis')"><i class="fa-solid fa-fingerprint"></i> {{ t['menu'][4] }}</li>
            <li onclick="showPage('matchmaker')"><i class="fa-solid fa-people-arrows"></i> {{ t['menu'][5] }}</li>
            <li onclick="showPage('library')"><i class="fa-solid fa-heart"></i> {{ t['menu'][6] }}</li>
        </ul>
    </div>

    <div class="main-container">
        
        <div id="chat_home" class="page-section active-section">
            <div class="chat-home-layout">
                
                <div class="controls-container">
                    <div class="custom-dropdown" id="personaDropdown">
                        <button class="dropdown-btn" onclick="togglePersonaDrop()">
                            <span id="selectedPersonaText">{{ t['personas'][0] }}</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </button>
                        <div class="dropdown-content">
                            {% for i in range(4) %}
                                <div onclick="selectPersona({{ i }}, '{{ t['personas'][i] }}')">
                                    {{ t['personas'][i] }}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <input type="hidden" id="persona-value" value="0">

                    <button class="refresh-icon-btn" onclick="resetChat()">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button>
                </div>

                <div id="chatbox" class="chat-box">
                    <div class="message bot-msg">
                        <div class="avatar">ğŸ¤–</div>
                        <div class="bubble" id="welcome-bubble">{{ t['welcome_msgs'][0] }}</div>
                    </div>
                </div>

                <div class="input-area">
                    <input type="text" id="user-input" placeholder="{{ t['input_placeholder'] }}">
                    <button class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="browse_movies" class="page-section"><h2 style="text-align:center">{{ t['browse_movies'] }}</h2><div id="m-res" class="grid-container"></div></div>
        <div id="browse_tv" class="page-section"><h2 style="text-align:center">{{ t['browse_tv'] }}</h2><div id="t-res" class="grid-container"></div></div>
        
        </div>

    <div id="modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('modal').style.display='none'">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        const t_welcome = {{ t['welcome_msgs'] | tojson }};
        const t_personas = {{ t['personas'] | tojson }};

        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© (Ù‡Ø§Ù…Ø¨Ø±ØºØ±)
        function toggleMenu() {
            document.getElementById('navMenu').classList.toggle('active');
        }

        function showPage(id) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active-section'));
            document.getElementById(id).classList.add('active-section');
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            document.getElementById('navMenu').classList.remove('active');
        }

        // ÙˆØ¸Ø§Ø¦Ù Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø®ØµÙŠØ§Øª (Custom Dropdown)
        function togglePersonaDrop() {
            document.getElementById("personaDropdown").classList.toggle("show");
        }

        function selectPersona(index, name) {
            document.getElementById("selectedPersonaText").innerText = name;
            document.getElementById("persona-value").value = index;
            document.getElementById("personaDropdown").classList.remove("show");
            document.getElementById('welcome-bubble').innerText = t_welcome[index];
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-btn') && !event.target.closest('.dropdown-btn')) {
                var dropdowns = document.getElementsByClassName("custom-dropdown");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        // (Ø§Ù†Ø³Ø® Ø¨Ø§Ù‚ÙŠ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª: sendMessage, loadContent... Ù…Ù† Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
        // Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ±ÙƒØ² Ø¹Ù„Ù‰ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø´ÙƒÙ„
        
        function resetChat() {
            const idx = document.getElementById("persona-value").value;
            document.getElementById('chatbox').innerHTML = `
                <div class="message bot-msg"><div class="avatar">ğŸ¤–</div><div class="bubble">${t_welcome[idx]}</div></div>`;
        }

        async function sendMessage() {
            const msg = document.getElementById('user-input').value;
            if(!msg) return;
            const box = document.getElementById('chatbox');
            box.innerHTML += `<div class="message user-msg"><div class="bubble">${msg}</div></div>`;
            document.getElementById('user-input').value = '';
            
            const loader = document.createElement('div');
            loader.className = 'message bot-msg';
            loader.innerHTML = '<div class="avatar">ğŸ¤–</div><div class="bubble">...</div>';
            box.appendChild(loader);
            box.scrollTop = box.scrollHeight;

            const fd = new FormData();
            fd.append('msg', msg);
            fd.append('persona', t_personas[document.getElementById('persona-value').value]);

            try {
                const res = await fetch('/chat', {method:'POST', body:fd});
                const data = await res.json();
                loader.remove();
                
                let html = `<div class="message bot-msg"><div class="avatar">ğŸ¤–</div><div class="bubble">${data.response.replace(/\n/g, '<br>')}</div></div>`;
                box.insertAdjacentHTML('beforeend', html);
                box.scrollTop = box.scrollHeight;
            } catch(e) { console.log(e); }
        }
        
        // (ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ loadContent Ùˆ search ÙƒÙ…Ø§ ÙƒØ§Ù†Øª)
    </script>
</body>
</html>
