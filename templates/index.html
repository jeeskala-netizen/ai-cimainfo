<!DOCTYPE html>
<html lang="{{ lang }}" dir="{{ t['dir'] }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t['app_title'] }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div class="nav-wrapper">
        <div class="logo">{{ t['app_title'] }}</div>
        <ul class="nav-menu">
            <li onclick="showPage('chat_home')" class="active"><i class="fa-solid fa-comments"></i> {{ t['menu'][0] }}</li>
            <li onclick="showPage('browse_movies'); loadContent('movie', 'm-res')"><i class="fa-solid fa-film"></i> {{ t['menu'][1] }}</li>
            <li onclick="showPage('browse_tv'); loadContent('tv', 't-res')"><i class="fa-solid fa-tv"></i> {{ t['menu'][2] }}</li>
            <li onclick="showPage('visual_detective')"><i class="fa-solid fa-camera"></i> {{ t['menu'][3] }}</li>
            <li onclick="showPage('dna_analysis')"><i class="fa-solid fa-fingerprint"></i> {{ t['menu'][4] }}</li>
            <li onclick="showPage('matchmaker')"><i class="fa-solid fa-people-arrows"></i> {{ t['menu'][5] }}</li>
            <li onclick="showPage('library')"><i class="fa-solid fa-heart"></i> {{ t['menu'][6] }}</li>
        </ul>
        <div class="lang-switch">
            <a href="/change_lang/ar">AR</a> | <a href="/change_lang/en">EN</a> | <a href="/change_lang/de">DE</a>
        </div>
    </div>

    <div class="main-container">
        
        <div id="chat_home" class="page-section active-section">
            <div class="input-area" style="margin-bottom: 20px; justify-content: center;">
                <label style="color:#ccc; margin:0 10px;">{{ t['persona_label'] }}</label>
                <select id="persona-select" onchange="resetChat()">
                    {% for i in range(4) %} <option value="{{ i }}">{{ t['personas'][i] }}</option> {% endfor %}
                </select>
                <button onclick="resetChat()" style="padding: 5px 15px; font-size: 0.9rem;">
                    <i class="fa-solid fa-rotate-right"></i> {{ t['new_chat'] }}
                </button>
            </div>
            <div id="chatbox" class="chat-box">
                <div class="message bot-msg"><div class="avatar">ü§ñ</div><div class="bubble">{{ t['welcome_msgs'][0] }}</div></div>
            </div>
            <div class="input-area">
                <input type="text" id="user-input" placeholder="{{ t['input_placeholder'] }}">
                <button class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="browse_movies" class="page-section">
            <h2 style="text-align: center;">{{ t['browse_movies'] }}</h2>
            <div class="input-area" style="max-width: 600px; margin: 0 auto 30px;">
                <input type="text" id="m-search" placeholder="{{ t['search_placeholder'] }}">
                <button class="send-btn" onclick="search('m-search', 'movie', 'm-res')">üîç</button>
            </div>
            <div id="m-res" class="grid-container"></div>
        </div>

        <div id="browse_tv" class="page-section">
            <h2 style="text-align: center;">{{ t['browse_tv'] }}</h2>
            <div class="input-area" style="max-width: 600px; margin: 0 auto 30px;">
                <input type="text" id="t-search" placeholder="{{ t['search_placeholder'] }}">
                <button class="send-btn" onclick="search('t-search', 'tv', 't-res')">üîç</button>
            </div>
            <div id="t-res" class="grid-container"></div>
        </div>

        <div id="visual_detective" class="page-section">
            <h2 style="text-align: center;">{{ t['headers'][0] }}</h2>
            <p style="text-align: center; color:#ccc;">{{ t['descs'][0] }}</p>
            <div style="max-width: 500px; margin: 30px auto; text-align: center;">
                <input type="file" id="img-up" style="display:none" accept="image/*" onchange="previewImage()">
                <div class="file-upload-wrapper" onclick="document.getElementById('img-up').click()">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size: 3rem; color: #6a11cb;"></i>
                    <p>{{ t['upload_text'] }}</p>
                </div>
                <img id="img-preview" style="max-width: 100%; margin-top: 20px; border-radius: 15px; display: none;">
                <br>
                <button id="analyze-btn" class="btn-primary" style="display:none; width:100%;" onclick="analyzeImage()">{{ t['analyze_btn'] }}</button>
            </div>
            <div id="v-res" class="chat-box" style="margin-top:20px;"></div>
        </div>

        <div id="dna_analysis" class="page-section">
            <h2 style="text-align: center;">{{ t['headers'][1] }}</h2>
            <div style="max-width: 500px; margin: 30px auto; display: flex; flex-direction: column; gap: 15px;">
                <input type="text" id="d1" placeholder="{{ t['dna_inputs'][0] }}">
                <input type="text" id="d2" placeholder="{{ t['dna_inputs'][1] }}">
                <input type="text" id="d3" placeholder="{{ t['dna_inputs'][2] }}">
                <button class="btn-primary" onclick="analyzeDNA()">{{ t['dna_btn'] }}</button>
            </div>
            <div id="d-res" class="chat-box" style="margin-top:20px;"></div>
        </div>

        <div id="matchmaker" class="page-section">
            <h2 style="text-align: center;">{{ t['headers'][2] }}</h2>
            <p style="text-align: center; color:#ccc;">{{ t['descs'][2] }}</p>
            <div style="max-width: 600px; margin: 30px auto; display: flex; gap: 10px;">
                <input type="text" id="u1" placeholder="{{ t['match_inputs'][0] }}">
                <input type="text" id="u2" placeholder="{{ t['match_inputs'][1] }}">
            </div>
            <div style="text-align: center;"><button class="btn-primary" onclick="findMatch()">{{ t['match_btn'] }}</button></div>
            <div id="ma-res" class="chat-box" style="margin-top: 20px;"></div>
        </div>

        <div id="library" class="page-section">
            <h2 style="text-align: center;">{{ t['headers'][4] }}</h2>
            <p style="text-align: center;">üöß ŸÇÿ±Ÿäÿ®ÿßŸã</p>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        const t_welcome = {{ t['welcome_msgs'] | tojson }};
        
        // --- History & Navigation Logic ---
        window.history.replaceState({view: 'home'}, null, "");
        
        window.addEventListener('popstate', function(event) {
            const modal = document.getElementById('modal');
            if (modal.style.display === "flex") {
                modal.style.display = "none";
            } else if (event.state && event.state.view === 'page') {
                showPage(event.state.id, false);
            }
        });

        function showPage(id, addHistory=true) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active-section'));
            document.getElementById(id).classList.add('active-section');
            document.querySelectorAll('.nav-menu li').forEach(li => li.classList.remove('active'));
            // Highlight active link
            const targetLink = document.querySelector(`li[onclick*="${id}"]`);
            if(targetLink) targetLink.classList.add('active');

            if(addHistory) history.pushState({view: 'page', id: id}, null, `?p=${id}`);
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            // ÿßŸÑÿ±ÿ¨Ÿàÿπ ŸÑŸÑÿÆŸÑŸÅ ŸÅŸä ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸÑŸÉŸä ŸÑÿß Ÿäÿ®ŸÇŸâ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÖÿπŸÑŸÇÿßŸã
            if(history.state && history.state.view === 'modal') history.back();
        }

        // --- Content Loading ---
        async function loadContent(type, outputId) {
            const div = document.getElementById(outputId);
            if(div.innerHTML.trim() !== "") return;
            div.innerHTML = '<div style="text-align:center; color:#ccc;">Loading...</div>';
            try {
                const fd = new FormData(); fd.append('type', type);
                const res = await fetch('/browse_content', {method:'POST', body:fd});
                const data = await res.json();
                renderGrid(data.movies, div);
            } catch(e) { div.innerHTML = '<p>Error.</p>'; }
        }

        function renderGrid(movies, container) {
            container.innerHTML = '';
            let html = `<div class="grid-container">`;
            movies.forEach(m => {
                const mStr = JSON.stringify(m).replace(/"/g, "&quot;");
                html += `<div class="movie-card" onclick="openModal(${mStr})"><img src="${m.poster}"><h4>${m.title}</h4></div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        // --- Chat Functions (XSS Protected) ---
        function resetChat() {
            const idx = document.getElementById('persona-select').value;
            document.getElementById('chatbox').innerHTML = `
                <div class="message bot-msg"><div class="avatar">ü§ñ</div><div class="bubble">${t_welcome[idx]}</div></div>`;
        }

        async function sendMessage() {
            const msgInput = document.getElementById('user-input');
            const msg = msgInput.value;
            if(!msg) return;
            
            const box = document.getElementById('chatbox');
            
            // XSS Protection: Create elements instead of innerHTML
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'message user-msg';
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.textContent = msg; // Secure way
            userMsgDiv.appendChild(bubble);
            box.appendChild(userMsgDiv);
            
            msgInput.value = '';
            
            // Loader
            const loaderDiv = document.createElement('div');
            loaderDiv.id = 'loader';
            loaderDiv.className = 'message bot-msg';
            loaderDiv.innerHTML = '<div class="avatar">ü§ñ</div><div class="bubble">...</div>';
            box.appendChild(loaderDiv);
            box.scrollTop = box.scrollHeight;

            const fd = new FormData();
            fd.append('msg', msg);
            fd.append('persona', document.getElementById('persona-select').options[document.getElementById('persona-select').selectedIndex].text);

            try {
                const res = await fetch('/chat', {method:'POST', body:fd});
                const data = await res.json();
                document.getElementById('loader').remove();
                renderResponse(data, box);
            } catch(e) { console.error(e); }
        }

        function renderResponse(data, container) {
            let html = `<div class="message bot-msg"><div class="avatar">ü§ñ</div><div class="bubble" style="max-width:100%">${data.response.replace(/\n/g, '<br>')}</div></div>`;
            if (data.movies && data.movies.length > 0) {
                html += `<div class="movie-gallery">`;
                data.movies.forEach(m => {
                    const mStr = JSON.stringify(m).replace(/"/g, "&quot;");
                    html += `<div class="movie-card" onclick="openModal(${mStr})"><img src="${m.poster}"><h4>${m.title}</h4></div>`;
                });
                html += `</div>`;
            }
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
        }

        // --- Other Features ---
        async function search(inId, type, outId) {
            const q = document.getElementById(inId).value;
            const fd = new FormData(); fd.append('query', q); fd.append('type', type);
            const res = await fetch('/search', {method:'POST', body:fd});
            renderGrid((await res.json()).movies, document.getElementById(outId));
        }

        async function analyzeDNA() {
            const fd = new FormData();
            fd.append('m1', document.getElementById('d1').value);
            fd.append('m2', document.getElementById('d2').value);
            fd.append('m3', document.getElementById('d3').value);
            const res = await fetch('/analyze_dna', {method:'POST', body:fd});
            renderResponse(await res.json(), document.getElementById('d-res'));
        }

        async function findMatch() {
            const fd = new FormData();
            fd.append('u1', document.getElementById('u1').value);
            fd.append('u2', document.getElementById('u2').value);
            const res = await fetch('/matchmaker', {method:'POST', body:fd});
            renderResponse(await res.json(), document.getElementById('ma-res'));
        }

        function previewImage() {
            const file = document.getElementById('img-up').files[0];
            if(file) {
                document.getElementById('img-preview').src = URL.createObjectURL(file);
                document.getElementById('img-preview').style.display = 'block';
                document.getElementById('analyze-btn').style.display = 'inline-block';
            }
        }
        async function analyzeImage() {
            const fd = new FormData(); fd.append('image', document.getElementById('img-up').files[0]);
            const res = await fetch('/analyze_image', {method:'POST', body:fd});
            renderResponse(await res.json(), document.getElementById('v-res'));
        }

        // --- Modal ---
        async function openModal(movie) {
            history.pushState({view: 'modal'}, null, "#details"); // Add to history
            const modal = document.getElementById('modal');
            modal.style.display = "flex";
            const body = document.getElementById('modal-body');
            body.innerHTML = `
                <div style="height:300px; background:url('${movie.poster}') center/cover; position:relative;">
                    <div style="position:absolute; bottom:0; background:linear-gradient(to top, #1a1a2e, transparent); width:100%; padding:20px; box-sizing:border-box;">
                        <h1 style="margin:0; text-shadow:0 0 10px black">${movie.title}</h1>
                    </div>
                </div>
                <div style="padding:20px;">
                    <p style="line-height:1.6">${movie.overview}</p>
                    <div id="provs" style="margin-top:20px">Loading...</div>
                </div>`;
            
            const fd = new FormData(); fd.append('id', movie.id); fd.append('type', movie.type);
            const res = await fetch('/get_details', {method:'POST', body:fd});
            const data = await res.json();
            
            let pHTML = `<h5>{{ t['details']['providers'] }}</h5><div style="display:flex; gap:10px; margin-bottom:20px;">`;
            if(data.providers.length > 0) data.providers.forEach(p => pHTML += `<img src="${p.logo}" width="50" style="border-radius:10px;">`);
            else pHTML += `<small>{{ t['details']['no_prov'] }}</small>`;
            pHTML += `</div>`;
            
            if(data.trailer) pHTML += `<a href="https://www.youtube.com/watch?v=${data.trailer}" target="_blank" class="btn-primary" style="text-decoration:none;">üé• {{ t['details']['trailer'] }}</a>`;
            document.getElementById('provs').innerHTML = pHTML;
        }

        document.getElementById("user-input").addEventListener("keypress", function(e){ if(e.key==="Enter") sendMessage(); });
    </script>
</body>
</html>
