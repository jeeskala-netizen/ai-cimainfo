<!-- templates/index.html - مُنقّح وقابل للتوسعة -->
<!doctype html>
<html lang="{{ lang }}" dir="{{ t['dir'] }}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>{{ t['app_title'] }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="" crossorigin="anonymous">
</head>
<body>
  <div class="nav-wrapper" role="navigation" aria-label="Main navigation">
    <div class="logo">{{ t['app_title'] }}</div>
    <div class="hamburger" id="hamburgerBtn" onclick="toggleMenu()" aria-label="Toggle menu" role="button" tabindex="0">
      <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </div>
    <ul class="nav-menu" id="navMenu" role="menubar">
      <li role="menuitem" onclick="showPage('chat_home')" class="active"><i class="fa-solid fa-comments"></i> {{ t['menu'][0] }}</li>
      <li role="menuitem" onclick="showPage('browse_movies'); loadContent('movie','m-res')"><i class="fa-solid fa-film"></i> {{ t['menu'][1] }}</li>
      <li role="menuitem" onclick="showPage('browse_tv'); loadContent('tv','t-res')"><i class="fa-solid fa-tv"></i> {{ t['menu'][2] }}</li>
      <li role="menuitem" onclick="showPage('visual_detective')"><i class="fa-solid fa-camera"></i> {{ t['menu'][3] }}</li>
      <li role="menuitem" onclick="showPage('dna_analysis')"><i class="fa-solid fa-fingerprint"></i> {{ t['menu'][4] }}</li>
      <li role="menuitem" onclick="showPage('matchmaker')"><i class="fa-solid fa-people-arrows"></i> {{ t['menu'][5] }}</li>
      <li role="menuitem" onclick="showPage('library')"><i class="fa-solid fa-heart"></i> {{ t['menu'][6] }}</li>
    </ul>
    <div class="lang-switch" aria-hidden="false">
      <a href="/change_lang/ar">AR</a> | <a href="/change_lang/en">EN</a> | <a href="/change_lang/de">DE</a>
    </div>
  </div>

  <main class="main-container">
    <div class="container">
      <!-- Chat Home -->
      <section id="chat_home" class="page-section active-section" aria-labelledby="chat-heading">
        <div class="chat-home-layout" role="region" aria-label="Chat area">
          <div class="controls-wrapper">
            <div style="display:flex;align-items:center;gap:8px">
              <span style="color:#aaa;"><i class="fa-solid fa-masks-theater"></i></span>
              <div class="custom-dropdown" id="persona-dropdown">
                <div class="dropdown-selected" onclick="toggleDropdown()" id="dropdownSelected">
                  <span id="selected-text">{{ t['personas'][0] }}</span>
                  <i class="fa-solid fa-chevron-down"></i>
                </div>
                <div class="dropdown-options" id="dropdownOptions">
                  {% for i in range(4) %}
                    <div class="option-item" onclick="selectPersona({{ i }}, '{{ t['personas'][i] }}')">{{ t['personas'][i] }}</div>
                  {% endfor %}
                </div>
                <input type="hidden" id="persona-value" value="0">
              </div>
            </div>
            <button class="send-btn" onclick="resetChat()" title="Reset chat"><i class="fa-solid fa-rotate-right"></i></button>
          </div>

          <div id="chatbox" class="chat-box" aria-live="polite">
            <div class="message bot-msg">
              <div class="avatar">[?]</div>
              <div class="bubble" id="welcome-bubble">{{ t['welcome_msgs'][0] }}</div>
            </div>
          </div>

          <div class="input-area" role="form" aria-label="Message input">
            <input type="text" id="user-input" placeholder="{{ t['input_placeholder'] }}" aria-label="Type your message">
            <button class="send-btn" onclick="sendMessage()" aria-label="Send message"><i class="fa-solid fa-paper-plane"></i></button>
          </div>
        </div>
      </section>

      <!-- Browse Movies -->
      <section id="browse_movies" class="page-section" aria-labelledby="browse-movies-heading">
        <h2>{{ t['browse_movies'] }}</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="text" id="m-search" placeholder="{{ t['search_placeholder'] }}" style="flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:#fff">
          <button class="send-btn" onclick="search('m-search','movie','m-res')"><i class="fa-solid fa-search"></i></button>
        </div>
        <div id="m-res" style="margin-top:16px"></div>
      </section>

      <!-- Browse TV -->
      <section id="browse_tv" class="page-section">
        <h2>{{ t['browse_tv'] }}</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="text" id="t-search" placeholder="{{ t['search_placeholder'] }}" style="flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:#fff">
          <button class="send-btn" onclick="search('t-search','tv','t-res')"><i class="fa-solid fa-search"></i></button>
        </div>
        <div id="t-res" style="margin-top:16px"></div>
      </section>

      <!-- Visual Detective -->
      <section id="visual_detective" class="page-section">
        <h2>{{ t['headers'][0] }}</h2>
        <p>{{ t['descs'][0] }}</p>
        <div style="text-align:center">
          <input type="file" id="img-up" accept="image/*" hidden onchange="previewImage()">
          <div onclick="document.getElementById('img-up').click()" style="cursor:pointer;border:2px dashed #6a11cb;padding:24px;border-radius:12px">
            <i class="fa-solid fa-cloud-upload-alt" style="font-size:2.2rem;color:#6a11cb"></i>
            <p>{{ t['upload_text'] }}</p>
          </div>
          <img id="img-preview" style="max-width:100%;margin-top:12px;border-radius:10px;display:none">
          <button id="analyze-btn" class="send-btn" style="display:none;margin-top:12px" onclick="analyzeImage()">{{ t['analyze_btn'] }}</button>
        </div>
        <div id="v-res" style="margin-top:16px"></div>
      </section>

      <!-- DNA Analysis -->
      <section id="dna_analysis" class="page-section">
        <h2>{{ t['headers'][1] }}</h2>
        <p>{{ t['descs'][1] }}</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="d1" placeholder="{{ t['dna_inputs'][0] }}" style="flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:#fff">
          <input id="d2" placeholder="{{ t['dna_inputs'][1] }}" style="flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:#fff">
          <input id="d3" placeholder="{{ t['dna_inputs'][2] }}" style="flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:#fff">
          <button class="send-btn" onclick="analyzeDNA()">{{ t['dna_btn'] }}</button>
        </div>
        <div id="d-res" style="margin-top:16px"></div>
      </section>

      <!-- Matchmaker -->
      <section id="matchmaker" class="page-section">
        <h2>{{ t['headers'][2] }}</h2>
        <p>{{ t['descs'][2] }}</p>
        <div style="display:flex;gap:8px">
          <input id="u1" placeholder="{{ t['match_inputs'][0] }}" style="flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:#fff">
          <input id="u2" placeholder="{{ t['match_inputs'][1] }}" style="flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:#fff">
          <button class="send-btn" onclick="findMatch()">{{ t['match_btn'] }}</button>
        </div>
        <div id="ma-res" style="margin-top:16px"></div>
      </section>

      <!-- Library -->
      <section id="library" class="page-section">
        <h2>{{ t['headers'][4] }}</h2>
        <div style="text-align:center;padding:20px;color:var(--text-muted)"><p>Coming soon</p></div>
      </section>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" style="display:none">
    <div class="modal-content" id="modal-body"></div>
  </div>

  <script>
    // بيانات من السيرفر
    const t_welcome = {{ t['welcome_msgs'] | tojson }};
    const t_personas = {{ t['personas'] | tojson }};

    // مساعدة DOM
    function byId(id){ return document.getElementById(id); }

    function toggleMenu(){
      const menu = byId('navMenu');
      menu.classList.toggle('active');
    }

    function showPage(id){
      document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active-section'));
      const el = byId(id);
      if(el) el.classList.add('active-section');
      // اغلاق القائمة على الموبايل
      const menu = byId('navMenu'); if(menu) menu.classList.remove('active');
      // تحديث زر نشط
      document.querySelectorAll('.nav-menu li').forEach(li => li.classList.remove('active'));
      const clicked = Array.from(document.querySelectorAll('.nav-menu li')).find(li => li.getAttribute('onclick') && li.getAttribute('onclick').includes(id));
      if(clicked) clicked.classList.add('active');
    }

    // Dropdown
    function toggleDropdown(){ byId('persona-dropdown').classList.toggle('active'); }
    function selectPersona(index, name){
      byId('selected-text').innerText = name;
      byId('persona-value').value = index;
      byId('persona-dropdown').classList.remove('active');
      byId('welcome-bubble').innerText = t_welcome[index] || t_welcome[0];
    }
    window.addEventListener('click', function(e){
      if(!e.target.closest('#persona-dropdown')) byId('persona-dropdown').classList.remove('active');
    });

    // Render grid helper
    function renderGrid(movies, container){
      if(!movies || movies.length === 0){ container.innerHTML = '<div style="color:#ccc;padding:12px">No results</div>'; return; }
      let html = '<div class="grid-container">';
      movies.forEach(m => {
        const mEsc = JSON.stringify(m).replace(/"/g,'&quot;');
        html += `<div class="movie-card" onclick='openModal(${mEsc})'><img src="${m.poster}" alt="${m.title}"><h4>${m.title}</h4></div>`;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    // Load content (with caching on client)
    async function loadContent(type, outputId){
      const div = byId(outputId);
      if(div.dataset.loaded) return;
      div.innerHTML = '<div style="text-align:center;color:#ccc;padding:12px">Loading...</div>';
      try{
        const fd = new FormData(); fd.append('type', type);
        const res = await fetch('/browse_content', {method:'POST', body:fd});
        const data = await res.json();
        renderGrid(data.movies, div);
        div.dataset.loaded = "1";
      }catch(e){
        div.innerHTML = '<div style="color:#f66">Error loading</div>';
      }
    }

    // Modal
    async function openModal(movie){
      const modal = byId('modal'); const body = byId('modal-body');
      modal.style.display = 'flex';
      body.innerHTML = `
        <div style="height:320px;background:url('${movie.poster}') center/cover;position:relative;">
          <div style="position:absolute;bottom:0;left:0;right:0;padding:16px;background:linear-gradient(to top, rgba(10,10,20,0.9), transparent)">
            <h2 style="margin:0;color:#fff">${movie.title}</h2>
          </div>
        </div>
        <div style="padding:16px">
          <p style="color:var(--text-muted)">${movie.overview || ''}</p>
          <div id="provs" style="margin-top:12px;color:var(--text-muted)">Loading providers...</div>
        </div>
      `;
      // fetch providers
      try{
        const fd = new FormData(); fd.append('id', movie.id); fd.append('type', movie.type);
        const res = await fetch('/get_details', {method:'POST', body:fd});
        const data = await res.json();
        const provs = data.providers || [];
        const provHtml = provs.map(p => `<div style="display:inline-flex;align-items:center;gap:8px;margin-right:8px"><img src="${p.logo}" style="height:28px"/><span style="color:#fff">${p.name}</span></div>`).join('');
        byId('provs').innerHTML = provHtml || '<div style="color:var(--text-muted)">No providers found</div>';
      }catch(e){
        byId('provs').innerHTML = '<div style="color:#f66">Error loading providers</div>';
      }
      history.pushState({modal:true}, '', '#details');
    }
    // close modal on click outside
    document.getElementById('modal').addEventListener('click', function(e){
      if(e.target === this){ this.style.display = 'none'; history.back(); }
    });

    // Chat functions
    function resetChat(){
      const idx = byId('persona-value').value || 0;
      byId('chatbox').innerHTML = `<div class="message bot-msg"><div class="avatar">[?]</div><div class="bubble">${t_welcome[idx]}</div></div>`;
    }

    async function sendMessage(){
      const msg = byId('user-input').value.trim();
      if(!msg) return;
      const box = byId('chatbox');
      box.insertAdjacentHTML('beforeend', `<div class="message user-msg"><div class="avatar">You</div><div class="bubble">${escapeHtml(msg)}</div></div>`);
      byId('user-input').value = '';
      box.insertAdjacentHTML('beforeend', `<div id="loading" class="message bot-msg"><div class="avatar">...</div><div class="bubble">...</div></div>`);
      box.scrollTop = box.scrollHeight;
      try{
        const fd = new FormData(); fd.append('msg', msg); fd.append('persona', t_personas[byId('persona-value').value || 0]);
        const res = await fetch('/chat', {method:'POST', body:fd});
        const data = await res.json();
        const loading = byId('loading'); if(loading) loading.remove();
        let html = `<div class="message bot-msg"><div class="avatar">Bot</div><div class="bubble" style="max-width:100%">${(data.response||'').replace(/\n/g,'<br>')}</div></div>`;
        if(data.movies && data.movies.length){
          html += '<div style="display:flex;gap:10px;overflow-x:auto;padding:10px 0 10px 0">';
          data.movies.forEach(m => { html += `<div class="movie-card" style="min-width:120px" onclick='openModal(${JSON.stringify(m).replace(/"/g,'&quot;')})'><img src="${m.poster}" alt="${m.title}"></div>`; });
          html += '</div>';
        }
        box.insertAdjacentHTML('beforeend', html);
        box.scrollTop = box.scrollHeight;
      }catch(e){
        const loading = byId('loading'); if(loading) loading.remove();
        box.insertAdjacentHTML('beforeend', `<div class="message bot-msg"><div class="avatar">Bot</div><div class="bubble">Error contacting server</div></div>`);
      }
    }

    // Helpers
    function escapeHtml(s){ return s.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

    // Search
    async function search(inId, type, outId){
      const q = byId(inId).value.trim();
      if(!q) return;
      const out = byId(outId);
      out.innerHTML = '<div style="color:#ccc;padding:12px">Loading...</div>';
      try{
        const fd = new FormData(); fd.append('query', q); fd.append('type', type);
        const res = await fetch('/search', {method:'POST', body:fd});
        const data = await res.json();
        renderGrid(data.movies, out);
      }catch(e){
        out.innerHTML = '<div style="color:#f66">Error</div>';
      }
    }

    // Analyze image
    function previewImage(){
      const file = byId('img-up').files[0];
      if(file){
        byId('img-preview').src = URL.createObjectURL(file);
        byId('img-preview').style.display = 'block';
        byId('analyze-btn').style.display = 'inline-block';
      }
    }
    async function analyzeImage(){
      const file = byId('img-up').files[0];
      if(!file) return;
      const fd = new FormData(); fd.append('image', file);
      const res = await fetch('/analyze_image', {method:'POST', body:fd});
      const data = await res.json();
      renderResults(data, 'v-res');
    }

    // DNA & Matchmaker
    async function analyzeDNA(){
      const fd = new FormData(); fd.append('m1', byId('d1').value); fd.append('m2', byId('d2').value); fd.append('m3', byId('d3').value);
      const res = await fetch('/analyze_dna', {method:'POST', body:fd});
      const data = await res.json();
      renderResults(data, 'd-res');
    }
    async function findMatch(){
      const fd = new FormData(); fd.append('u1', byId('u1').value); fd.append('u2', byId('u2').value);
      const res = await fetch('/matchmaker', {method:'POST', body:fd});
      const data = await res.json();
      renderResults(data, 'ma-res');
    }

    function renderResults(data, containerId){
      const div = byId(containerId);
      const html = `<div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;margin-bottom:8px"><p style="color:var(--text-muted)">${(data.response||'').replace(/\n/g,'<br>')}</p></div>`;
      div.innerHTML = html;
      if(data.movies && data.movies.length) renderGrid(data.movies, div);
    }
  </script>
</body>
</html>
